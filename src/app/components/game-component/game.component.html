<div class="table">
  <div class="game-board">
    <span class="board-wrapper">
      <div class="board-1"></div>
      <div class="board-2"></div>
      <div class="board-3"></div>
    </span>

    <span class="board-wrapper">
      <div class="board-4"></div>
      <div class="board-5"></div>
      <div class="board-6"></div>
    </span>

    <span class="board-wrapper">
      <div class="board-7"></div>
      <div class="board-8"></div>
      <div class="board-9"></div>
    </span>

    <app-character-info
      *ngIf="characterBeingControlledByClient"
      [character]="characterBeingControlledByClient"
      (showCharacterMenu)="toggleCharacterMenu()"
    ></app-character-info>

    <app-location-info
      *ngIf="!showEventCard"
      [location]="characterBeingControlledByClient?.currentLocation"
    ></app-location-info>

    @defer(when showEventCard) {
    <!-- Only appears when you draw an event card -->
    <app-event-menu
      *ngIf="showEventCard"
      [cardName]="cardName"
      [deckName]="deckName"
      (closeCard)="closeCard()"
      (makeChoice)="makeChoice($event)"
    ></app-event-menu>
    } @defer(when showItemCard) {
    <!-- Appears if you are viewing an item -->
    <app-item-menu
      *ngIf="showItemCard"
      [cardName]="cardName"
      (closeMenu)="addItemToPlayerInventory()"
    ></app-item-menu>
    } @defer(when showWeaponCard) {
    <!-- Appears when you are viewing a weapon card -->
    <app-weapon-menu
      *ngIf="showWeaponCard"
      [cardName]="cardName"
      (closeMenu)="addWeaponToPlayerInventory()"
    ></app-weapon-menu>
    } @defer(when showGoldCard){
    <!-- Appears when the character finds gold -->
    <app-gold-menu
      *ngIf="showGoldCard"
      [goldAmount]="goldFoundAmount"
      (closeMenu)="addGoldToCharacter()"
    >
    </app-gold-menu>
    }

    <!-- Defer the character menu using the Angular 17 syntax to lazy load a large component on a condition -->
    @defer (when showCharacterMenu) {
    <!-- Appears when you are viewing the character menu -->
    <app-character-menu
      *ngIf="showCharacterMenu"
      [character]="characterBeingControlledByClient"
      (closeMenu)="showCharacterMenu = false"
    >
    </app-character-menu>
    } @defer (when currentCharacterRollingDice) {
    <app-dice-roll-dialog
      *ngIf="currentCharacterRollingDice"
      [data]="diceRollingData"
      (successClose)="
        currentCharacterRollingDice = false;
        drawEventCard();
        currentCharacterRolledForEventCardThisTurn = true
      "
      (close)="
        currentCharacterRollingDice = false;
        currentCharacterRolledForEventCardThisTurn = true
      "
    ></app-dice-roll-dialog>
    }

    <span *ngFor="let character of allCharactersCurrentlyInGameSession">
      <div
        class="player-wrapper"
        [ngStyle]="{
          'left.px': character.currentLocation.position.xPosition + 25,
          'top.px': character.currentLocation.position.yPosition - 80
        }"
      >
        <app-turn-arrow
          *ngIf="characterBeingControlledByClient?.id === character.id"
        ></app-turn-arrow>
        <span class="character-name big-text">{{ character.name }}</span>
        <app-player
          [directionFacing]="character.directionFacing"
          [character]="character"
        ></app-player>
      </div>
    </span>

    <span *ngFor="let location of this.locationService.locationsMap | keyvalue">
      <div
        class="movement-node-wrapper"
        (click)="locationService.clickOnNode(location.value)"
        [ngStyle]="{
          'left.px': location.value.position.xPosition,
          'top.px': location.value.position.yPosition
        }"
      >
        <!-- For Testing Purposes -->
        <!-- <h1>{{ location.key }}</h1> -->
        <app-movement-node
          *ngIf="!locationsLoading"
          [distanceFromCharacter]="location.value.distanceFromPlayer"
          [characterMovementSpeed]="
            characterBeingControlledByClient?.movementSpeed ?? 0
          "
        />
      </div>
    </span>

    <div
      class="player-game-messages-section"
      *ngIf="!currentCharacterRollingDice"
    >
      <span
        class="player-movement-section"
        *ngIf="
          characterBeingControlledByClient?.movementSpeed != undefined &&
          !currentCharacterRolledForEventCardThisTurn
        "
      >
        <p
          class="big-text sticky-text"
          *ngIf="characterBeingControlledByClient!.movementSpeed > 0"
        >
          Movement: {{ characterBeingControlledByClient!.movementSpeed }}
        </p>

        <p
          class="big-text sticky-text"
          *ngIf="characterBeingControlledByClient!.movementSpeed <= 0"
        >
          You cannot move anymore this turn.
        </p>
      </span>

      <span class="player-misc-message-section">
        <p class="big-text sticky-text" *ngIf="waitingForNextTurnToStart">
          Waiting for other players to finish their turns...
        </p>
      </span>
    </div>

    <div class="game-buttons-section" *ngIf="!currentCharacterRollingDice">
      <span
        *ngIf="characterBeingControlledByClient?.movementSpeed != undefined"
      >
        <div
          class="game-button"
          *ngIf="!currentCharacterRolledForEventCardThisTurn"
          (click)="endMovement()"
        >
          End Movement
        </div>

        <div
          class="game-button"
          *ngIf="
            currentCharacterRolledForEventCardThisTurn &&
            !waitingForNextTurnToStart
          "
          (click)="currentCharacterFinishedTurn()"
        >
          End Turn
        </div>
      </span>
    </div>

    <!-- Legacy because it will be replaced with other components. -->
    <!-- <app-game-footer
      *ngIf="!loading"
      [characterName]="characterBeingControlledByClient?.name"
      [characterMovementSpeed]="characterBeingControlledByClient?.movementSpeed"
      [turnNumber]="gameSession?.currentTurn?.turnNumber || 0"
      [waitingForOnlinePlayersToFinishTurn]="waitingForNextTurnToStart"
      (endTurn)="currentCharacterFinishedTurn()"
      (drawEventCard)="drawEventCard()"
    ></app-game-footer> -->
  </div>
</div>
